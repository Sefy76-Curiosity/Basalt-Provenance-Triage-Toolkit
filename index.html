<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <title>Scientific Toolkit Mobile ¬∑ Hardware Suite</title>
  <style>
    /* ----- RESET & VARIABLES ----- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg: #0a0c10;
      --surface: #161b22;
      --surface-light: #1f2633;
      --border: #2d333b;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #238636;
      --accent-hover: #2ea043;
      --danger: #da3633;
      --warning: #e3b341;
      --info: #1f6feb;
      --radius: 12px;
      --spacing: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      height: 100vh;
      overflow: hidden;
    }

    /* ----- UTILITY CLASSES ----- */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; }
    .gap-4 { gap: 16px; }
    .p-4 { padding: 16px; }
    .m-4 { margin: 16px; }
    .w-full { width: 100%; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .text-accent { color: var(--accent); }
    .text-danger { color: var(--danger); }
    .bg-surface { background: var(--surface); }
    .rounded { border-radius: var(--radius); }
    .border { border: 1px solid var(--border); }

    /* ----- BUTTONS ----- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: var(--radius);
      border: none;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--surface-light);
      color: var(--text);
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    .btn:active { transform: scale(0.97); opacity: 0.9; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); }
    .btn-sm { padding: 8px 12px; font-size: 14px; }
    .btn-lg { padding: 16px 24px; font-size: 18px; }
    .btn-full { width: 100%; }

    /* ----- CARDS & CONTAINERS ----- */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 16px;
    }

    /* ----- FORM ELEMENTS ----- */
    input, select, textarea {
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      color: var(--text);
      font-size: 16px;
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
    }

    label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
      color: var(--text-muted);
    }

    /* ----- BOTTOM NAVIGATION (phone) ----- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 4px;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-muted);
      transition: color 0.2s;
      flex: 1;
      padding: 4px 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-icon {
      font-size: 24px;
    }

    /* ----- MAIN CONTENT AREA (phone) ----- */
    .main-content {
      height: 100vh;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 80px;
      -webkit-overflow-scrolling: touch;
    }

    /* ----- TABLET LAYOUT (‚â•768px) ----- */
    @media (min-width: 768px) {
      .bottom-nav {
        display: none;
      }

      .tablet-nav {
        display: flex;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 8px 16px;
        gap: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tablet-nav-item {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 16px;
        padding: 8px 12px;
        cursor: pointer;
        white-space: nowrap;
      }

      .tablet-nav-item.active {
        color: var(--accent);
        border-bottom: 2px solid var(--accent);
      }

      .main-content {
        padding: 20px;
        padding-bottom: 20px;
        height: calc(100vh - 60px);
      }

      /* Three‚Äëpanel layout for samples view */
      .samples-panels {
        display: grid;
        grid-template-columns: 300px 1fr 280px;
        gap: 16px;
        height: 100%;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
        overflow-y: auto;
      }

      .panel-left {
        /* left panel ‚Äì import, manual entry, hardware */
      }

      .panel-center {
        /* center panel ‚Äì table */
        display: flex;
        flex-direction: column;
<<<<<<< HEAD
        overflow: hidden;
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }

      .panel-right {
        /* right panel ‚Äì classification HUD */
      }

<<<<<<< HEAD
      /* Scrollable table container */
      .table-container {
        overflow-x: auto;
        overflow-y: auto;
        flex: 1;
        border: 1px solid var(--border);
        border-radius: var(--radius);
      }

      .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 100%;
=======
      .sample-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }

      .sample-table th {
        text-align: left;
        padding: 8px;
        background: var(--surface-light);
        color: var(--text-muted);
        font-weight: 500;
        position: sticky;
        top: 0;
<<<<<<< HEAD
        z-index: 10;
        white-space: nowrap;
      }

      .sample-table td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
=======
      }

      .sample-table td {
        padding: 8px;
        border-bottom: 1px solid var(--border);
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }

      .sample-table tr:active {
        background: var(--surface-light);
      }

      .hud-tree {
        list-style: none;
        margin-top: 8px;
      }

      .hud-item {
        display: flex;
        justify-content: space-between;
<<<<<<< HEAD
        padding: 8px;
        border-bottom: 1px solid var(--border);
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s;
        border-radius: 4px;
      }

      .hud-item:hover {
        background: var(--surface-light);
      }

      .hud-item:active {
        background: var(--surface-light);
        transform: scale(0.98);
=======
        padding: 6px 8px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }

      .hud-class {
        color: var(--accent);
<<<<<<< HEAD
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
        font-weight: 500;
      }

      .hud-id {
        color: var(--text-muted);
        margin: 0 4px;
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }

      .hud-conf {
        color: var(--text-muted);
<<<<<<< HEAD
        min-width: 35px;
        text-align: right;
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }
    }

    /* ----- SAMPLES LIST (phone) ----- */
    .sample-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sample-item:active {
      background: var(--surface-light);
    }

    .sample-id {
      font-weight: 600;
      color: var(--accent);
    }

    .sample-class {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      background: rgba(35, 134, 54, 0.2);
      color: var(--accent);
    }

    /* ----- SPINNER ----- */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ----- TOAST ----- */
    #toast-container {
      position: fixed;
      bottom: 90px;
      left: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      background: var(--surface);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.error { border-left-color: var(--danger); }
    .toast.warning { border-left-color: var(--warning); }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ----- CAMERA ZONE ----- */
    .camera-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 40px 20px;
      text-align: center;
      background: var(--surface-light);
      cursor: pointer;
      position: relative;
    }

    .camera-zone input[type=file] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius);
      margin-top: 12px;
    }
<<<<<<< HEAD

    /* Import progress bar */
    .import-progress {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .import-progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
  </style>
</head>
<body>
  <!-- SPLASH SCREEN -->
  <div id="splash" class="flex items-center justify-center" style="position:fixed; inset:0; background:var(--bg); z-index:2000;">
    <div class="text-center">
      <div style="font-size:64px; margin-bottom:16px;">üî¨</div>
      <h1 style="font-size:28px; font-weight:600; color:var(--accent);">Scientific Toolkit</h1>
      <p style="color:var(--text-muted);">Mobile Interface ¬∑ Hardware Suite</p>
    </div>
  </div>

  <!-- CONNECT SCREEN -->
  <div id="connect-screen" class="main-content">
    <div class="card" style="max-width:400px; margin:20px auto;">
      <div style="font-size:48px; text-align:center; margin-bottom:16px;">üì°</div>
      <h2 style="text-align:center; margin-bottom:8px;">Connect to Desktop</h2>
      <p class="text-muted text-center" style="margin-bottom:24px;">Enter the server address shown in the Mobile Sync plugin</p>
      <div style="margin-bottom:16px;">
        <label>Server URL</label>
        <input type="url" id="server-url" placeholder="https://192.168.1.100:5000" value="">
      </div>
      <div style="margin-bottom:24px;">
        <label>Auth Token (optional)</label>
        <input type="password" id="auth-token" placeholder="token">
      </div>
      <div class="flex gap-2">
        <button class="btn btn-outline flex-1" id="test-connection">Test</button>
        <button class="btn btn-primary flex-1" id="connect-btn">Connect</button>
      </div>
      <div id="connection-status" class="text-center text-muted" style="margin-top:16px;">Ready</div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden">
    <!-- Phone bottom navigation -->
    <nav class="bottom-nav">
      <button class="nav-item active" data-view="samples">üìã<span>Samples</span></button>
      <button class="nav-item" data-view="add">‚ûï<span>Add</span></button>
      <button class="nav-item" data-view="classify">üî¨<span>Classify</span></button>
      <button class="nav-item" data-view="camera">üì∑<span>Camera</span></button>
      <button class="nav-item" data-view="settings">‚öôÔ∏è<span>Settings</span></button>
    </nav>

    <!-- Tablet top navigation (hidden on phone) -->
    <nav class="tablet-nav hidden">
      <button class="tablet-nav-item active" data-view="samples">üìã Samples</button>
      <button class="tablet-nav-item" data-view="add">‚ûï Add</button>
      <button class="tablet-nav-item" data-view="classify">üî¨ Classify</button>
      <button class="tablet-nav-item" data-view="camera">üì∑ Camera</button>
      <button class="tablet-nav-item" data-view="settings">‚öôÔ∏è Settings</button>
    </nav>

    <!-- Views -->
    <!-- SAMPLES VIEW ‚Äì with three-panel layout on tablet -->
    <div class="main-content" id="samples-view">
      <!-- On phone, we still show the list view; on tablet we show panels -->
      <div class="phone-samples-list">
        <div style="margin-bottom:12px;">
          <input type="search" id="sample-search" placeholder="Search samples..." style="width:100%;">
        </div>
        <div class="flex items-center justify-between" style="margin-bottom:12px;">
          <h2>Samples</h2>
          <span id="sample-count" class="text-muted">0</span>
        </div>
        <div id="sample-list" style="margin-bottom:12px;">
          <div class="spinner"></div>
        </div>
        <div class="flex items-center justify-between">
          <button class="btn btn-outline btn-sm" id="prev-page">‚Üê Prev</button>
          <span id="page-info" class="text-muted">Page 1</span>
          <button class="btn btn-outline btn-sm" id="next-page">Next ‚Üí</button>
        </div>
      </div>

      <!-- Tablet three-panel layout (initially hidden on phone) -->
      <div class="samples-panels hidden">
        <!-- LEFT PANEL: Import, Manual Entry, Hardware -->
        <div class="panel panel-left">
<<<<<<< HEAD
          <!-- IMPORT SECTION - Now with real functionality -->
          <div style="margin-bottom:16px;">
            <label class="text-accent" style="font-weight:bold;">üìÇ Import Data</label>
            <div class="camera-zone" style="padding:20px;" id="import-zone">
              <input type="file" id="import-file-input" accept=".csv,.xlsx,.xls,.txt,.mca,.spec" multiple>
              <div style="font-size:32px;">üìÅ</div>
              <div>Tap to select files</div>
              <div class="text-muted" style="font-size:11px;">CSV, Excel, TXT, MCA, SPEC</div>
            </div>
            <div id="import-progress-container" style="display:none; margin-top:8px;">
              <div class="import-progress">
                <div class="import-progress-fill" id="import-progress-fill" style="width:0%"></div>
              </div>
              <div class="flex justify-between" style="margin-top:4px;">
                <span class="text-muted" id="import-status">Processing...</span>
                <span class="text-muted" id="import-percent">0%</span>
              </div>
            </div>
          </div>
=======
          <button class="btn btn-outline btn-full" style="margin-bottom:12px;" id="tablet-import">üìÇ Import Data</button>
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377

          <h4 style="margin:12px 0 8px;">Manual Entry</h4>
          <div style="margin-bottom:8px;">
            <label>Sample ID</label>
            <input type="text" id="tablet-sample-id" placeholder="e.g. SAMPLE001">
          </div>
          <div style="margin-bottom:12px;">
            <label>Notes</label>
            <textarea id="tablet-notes" rows="2" placeholder="Field notes..."></textarea>
          </div>
          <button class="btn btn-primary btn-full" id="tablet-add-row">‚ûï Add Row</button>

          <!-- HARDWARE INPUT SECTION -->
          <h4 style="margin:20px 0 8px;">üîå Hardware Input</h4>
          <div style="margin-bottom:8px;">
            <label>Device</label>
            <select id="hardware-device-select" class="form-select">
              <option value="">-- Select device --</option>
              <option value="gps">üåç GPS (built‚Äëin)</option>
              <option value="camera-barcode">üì∑ Barcode Scanner (Camera)</option>
              <option value="ble-caliper">üìè Bluetooth Caliper (Sylvac etc.)</option>
              <option value="serial-balance">‚öñÔ∏è Balance (USB‚ÄëSerial)</option>
              <option value="mineralogy">üíé Mineralogy ID (RRUFF)</option>
            </select>
          </div>

          <div class="flex gap-2" style="margin-bottom:8px;">
            <button class="btn btn-outline flex-1" id="hardware-connect-btn">Connect</button>
            <button class="btn btn-primary flex-1" id="hardware-read-btn">Read</button>
          </div>

          <div class="card" style="padding:8px; font-size:13px; min-height:50px;" id="hardware-status">
            Ready
          </div>

          <!-- (Optional) Bluetooth device list placeholder -->
          <div id="bluetooth-device-list" style="margin-top:8px; display:none;">
            <label>Paired Devices</label>
            <select id="ble-device-select" class="form-select"></select>
          </div>
        </div>

<<<<<<< HEAD
        <!-- CENTER PANEL: Search, Dynamic Table, Pagination -->
=======
        <!-- CENTER PANEL: Search, Table, Pagination -->
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
        <div class="panel panel-center">
          <div style="margin-bottom:12px;">
            <input type="search" id="tablet-search" placeholder="Search samples..." style="width:100%;">
          </div>
<<<<<<< HEAD
          <div class="table-container" id="table-container">
            <table class="sample-table" id="dynamic-sample-table">
              <thead id="table-header">
                <tr id="header-row"></tr>
              </thead>
              <tbody id="table-body"></tbody>
=======
          <div style="overflow-y: auto; flex:1;">
            <table class="sample-table" id="sample-table">
              <thead>
                <tr><th>ID</th><th>Classification</th><th>Conf</th></tr>
              </thead>
              <tbody id="sample-table-body"></tbody>
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
            </table>
          </div>
          <div class="flex items-center justify-between" style="margin-top:12px;">
            <button class="btn btn-outline btn-sm" id="tablet-prev-page">‚Üê Prev</button>
            <span id="tablet-page-info" class="text-muted">Page 1</span>
            <button class="btn btn-outline btn-sm" id="tablet-next-page">Next ‚Üí</button>
          </div>
        </div>

        <!-- RIGHT PANEL: Classification & HUD -->
        <div class="panel panel-right">
          <h4>Classification</h4>
          <select id="tablet-scheme-select" style="margin-bottom:12px;"></select>
          <div class="flex gap-2" style="margin-bottom:16px;">
            <button class="btn btn-outline flex-1" id="tablet-classify-selected">Selected</button>
            <button class="btn btn-primary flex-1" id="tablet-classify-all">All</button>
          </div>
          <h4>HUD</h4>
          <ul class="hud-tree" id="hud-list"></ul>
        </div>
      </div>
    </div>

    <!-- ADD VIEW (phone) -->
    <div class="main-content hidden" id="add-view">
      <h2 style="margin-bottom:16px;">Add Sample</h2>
      <div class="card" style="margin-bottom:16px;">
        <div style="margin-bottom:12px;">
          <label>Sample ID *</label>
          <input type="text" id="add-sample-id" placeholder="e.g., SAMPLE001">
        </div>
        <div style="margin-bottom:12px;">
          <label>Notes</label>
          <textarea id="add-notes" rows="3" placeholder="Field notes..."></textarea>
        </div>
        <button class="btn btn-primary btn-full" id="submit-sample">Submit</button>
      </div>
      <div class="camera-zone" id="gps-button">
        <div style="font-size:32px;">üõ∞Ô∏è</div>
        <div>Tap to get GPS location</div>
        <div id="gps-status" class="text-muted" style="font-size:12px; margin-top:8px;">Not acquired</div>
      </div>
    </div>

    <!-- CLASSIFY VIEW (phone) -->
    <div class="main-content hidden" id="classify-view">
      <h2 style="margin-bottom:16px;">Classification</h2>
      <div class="card" style="margin-bottom:16px;">
        <label>Scheme</label>
        <select id="scheme-select" style="margin-bottom:12px;"></select>
        <div class="flex gap-2">
          <button class="btn btn-outline flex-1" id="classify-selected">Selected</button>
          <button class="btn btn-primary flex-1" id="classify-all">All</button>
        </div>
      </div>
      <div id="classification-result" class="card hidden"></div>
    </div>

    <!-- CAMERA VIEW -->
    <div class="main-content hidden" id="camera-view">
      <h2 style="margin-bottom:16px;">Camera Upload</h2>
      <div class="camera-zone" id="camera-zone">
        <input type="file" id="camera-input" accept="image/*" capture="environment">
        <div style="font-size:48px;">üì∑</div>
        <div>Tap to take photo</div>
      </div>
      <div id="image-preview-container" class="hidden" style="margin-top:16px;">
        <img id="image-preview" class="image-preview" alt="Preview">
        <div style="margin-top:12px;">
          <label>Sample ID (optional)</label>
          <input type="text" id="photo-sample-id" placeholder="Link to sample">
        </div>
        <button class="btn btn-primary btn-full" id="upload-photo">Upload</button>
        <button class="btn btn-outline btn-full" id="cancel-photo">Cancel</button>
      </div>
      <div id="recent-uploads" style="margin-top:24px;"></div>
    </div>

    <!-- SETTINGS VIEW -->
    <div class="main-content hidden" id="settings-view">
      <h2 style="margin-bottom:16px;">Settings</h2>
      <div class="card" style="margin-bottom:16px;">
        <div style="margin-bottom:8px;"><span class="text-muted">Server:</span> <span id="settings-url"></span></div>
        <div style="margin-bottom:8px;"><span class="text-muted">Token:</span> <span id="settings-token"></span></div>
        <button class="btn btn-outline btn-full" id="disconnect">Disconnect</button>
      </div>

      <!-- HARDWARE SETTINGS -->
      <h3 style="margin:20px 0 8px;">üîß Hardware</h3>
      <div class="card" style="margin-bottom:16px;">
        <div style="margin-bottom:12px;">
          <label><input type="checkbox" id="hw-gps" checked> GPS (built‚Äëin)</label>
        </div>
        <div style="margin-bottom:12px;">
          <label><input type="checkbox" id="hw-camera-barcode" checked> Camera Barcode Scanner</label>
        </div>
        <div style="margin-bottom:12px;">
          <label><input type="checkbox" id="hw-ble-caliper" checked> Bluetooth Caliper</label>
          <button class="btn btn-sm btn-outline" style="margin-left:8px;" id="pair-ble-caliper">Pair New</button>
        </div>
        <div style="margin-bottom:12px;">
          <label><input type="checkbox" id="hw-serial-balance"> Balance (USB‚ÄëSerial) ‚Äì Android only</label>
          <button class="btn btn-sm btn-outline" style="margin-left:8px;" id="select-serial-port">Select Port</button>
        </div>
        <div style="margin-bottom:12px;">
          <label><input type="checkbox" id="hw-mineralogy" checked> Mineralogy ID (RRUFF)</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Sample detail sheet (modal) -->
  <div id="sample-sheet" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:2000; display:flex; align-items:flex-end;" onclick="if(event.target===this) closeSheet()">
    <div class="card" style="width:100%; max-height:80vh; overflow-y:auto; border-radius:16px 16px 0 0;" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between" style="padding:16px; border-bottom:1px solid var(--border);">
        <h3 id="sheet-sample-id">Sample</h3>
        <button class="btn btn-sm btn-outline" onclick="closeSheet()">‚úï</button>
      </div>
      <div id="sheet-content" style="padding:16px;"></div>
      <div class="flex gap-2" style="padding:16px; border-top:1px solid var(--border);">
        <button class="btn btn-danger flex-1" id="sheet-delete">Delete</button>
        <button class="btn btn-outline flex-1" id="sheet-classify">Classify</button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<<<<<<< HEAD
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
  <script>
    // ========== STATE ==========
    const STATE = {
      baseUrl: '',
      token: '',
      connected: false,
      currentPage: 0,
      pageSize: 25,
      totalSamples: 0,
      totalPages: 1,
      samples: [],
<<<<<<< HEAD
      allColumns: [], // Track all available columns
      visibleColumns: [], // Columns to display (can be customized later)
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      schemes: [],
      selectedScheme: null,
      columns: [],
      currentSample: null,
      uploadedImages: [],
      searchQuery: '',
      gps: { lat: null, lon: null },
      // Hardware preferences
      hardware: {
        gps: true,
        cameraBarcode: true,
        bleCaliper: true,
        serialBalance: false,
        mineralogy: true
      },
      // Paired BLE devices
      bleDevices: [],
      selectedBleDevice: null,
      // Serial port
<<<<<<< HEAD
      serialPort: null,
      // Track if schemes have been loaded
      schemesLoaded: false
    };

    // ========== COLUMN NORMALIZATION MAP ==========
    // Maps common column name variations to standardized names
    const COLUMN_NORMALIZATION = {
      // Sample ID variations
      'sample id': 'Sample_ID',
      'sampleid': 'Sample_ID',
      'id': 'Sample_ID',
      'sample': 'Sample_ID',

      // Element variations with ppm
      'zr ppm': 'Zr_ppm',
      'zr(ppm)': 'Zr_ppm',
      'zr': 'Zr_ppm',
      'nb ppm': 'Nb_ppm',
      'nb(ppm)': 'Nb_ppm',
      'nb': 'Nb_ppm',
      'ti ppm': 'Ti_ppm',
      'ti(ppm)': 'Ti_ppm',
      'ti': 'Ti_ppm',
      'ba ppm': 'Ba_ppm',
      'ba(ppm)': 'Ba_ppm',
      'ba': 'Ba_ppm',
      'rb ppm': 'Rb_ppm',
      'rb(ppm)': 'Rb_ppm',
      'rb': 'Rb_ppm',
      'cr ppm': 'Cr_ppm',
      'cr(ppm)': 'Cr_ppm',
      'cr': 'Cr_ppm',
      'ni ppm': 'Ni_ppm',
      'ni(ppm)': 'Ni_ppm',
      'ni': 'Ni_ppm',
      'v ppm': 'V_ppm',
      'v(ppm)': 'V_ppm',
      'v': 'V_ppm',
      'y ppm': 'Y_ppm',
      'y(ppm)': 'Y_ppm',
      'y': 'Y_ppm',
      'la ppm': 'La_ppm',
      'la(ppm)': 'La_ppm',
      'la': 'La_ppm',
      'ce ppm': 'Ce_ppm',
      'ce(ppm)': 'Ce_ppm',
      'ce': 'Ce_ppm',
      'nd ppm': 'Nd_ppm',
      'nd(ppm)': 'Nd_ppm',
      'nd': 'Nd_ppm',
      'sm ppm': 'Sm_ppm',
      'sm(ppm)': 'Sm_ppm',
      'sm': 'Sm_ppm',
      'eu ppm': 'Eu_ppm',
      'eu(ppm)': 'Eu_ppm',
      'eu': 'Eu_ppm',
      'gd ppm': 'Gd_ppm',
      'gd(ppm)': 'Gd_ppm',
      'gd': 'Gd_ppm',
      'dy ppm': 'Dy_ppm',
      'dy(ppm)': 'Dy_ppm',
      'dy': 'Dy_ppm',
      'er ppm': 'Er_ppm',
      'er(ppm)': 'Er_ppm',
      'er': 'Er_ppm',
      'yb ppm': 'Yb_ppm',
      'yb(ppm)': 'Yb_ppm',
      'yb': 'Yb_ppm',
      'lu ppm': 'Lu_ppm',
      'lu(ppm)': 'Lu_ppm',
      'lu': 'Lu_ppm',
      'hf ppm': 'Hf_ppm',
      'hf(ppm)': 'Hf_ppm',
      'hf': 'Hf_ppm',
      'ta ppm': 'Ta_ppm',
      'ta(ppm)': 'Ta_ppm',
      'ta': 'Ta_ppm',
      'pb ppm': 'Pb_ppm',
      'pb(ppm)': 'Pb_ppm',
      'pb': 'Pb_ppm',
      'th ppm': 'Th_ppm',
      'th(ppm)': 'Th_ppm',
      'th': 'Th_ppm',
      'u ppm': 'U_ppm',
      'u(ppm)': 'U_ppm',
      'u': 'U_ppm',
      'sr ppm': 'Sr_ppm',
      'sr(ppm)': 'Sr_ppm',
      'sr': 'Sr_ppm',
      'zn ppm': 'Zn_ppm',
      'zn(ppm)': 'Zn_ppm',
      'zn': 'Zn_ppm',
      'cu ppm': 'Cu_ppm',
      'cu(ppm)': 'Cu_ppm',
      'cu': 'Cu_ppm',
      'co ppm': 'Co_ppm',
      'co(ppm)': 'Co_ppm',
      'co': 'Co_ppm',
      'sc ppm': 'Sc_ppm',
      'sc(ppm)': 'Sc_ppm',
      'sc': 'Sc_ppm',
      'ga ppm': 'Ga_ppm',
      'ga(ppm)': 'Ga_ppm',
      'ga': 'Ga_ppm',
      'cs ppm': 'Cs_ppm',
      'cs(ppm)': 'Cs_ppm',
      'cs': 'Cs_ppm',

      // Oxide variations (wt%)
      'sio2': 'SiO2_wt',
      'sio2(wt%)': 'SiO2_wt',
      'sio2 wt%': 'SiO2_wt',
      'tio2': 'TiO2_wt',
      'tio2(wt%)': 'TiO2_wt',
      'tio2 wt%': 'TiO2_wt',
      'al2o3': 'Al2O3_wt',
      'al2o3(wt%)': 'Al2O3_wt',
      'al2o3 wt%': 'Al2O3_wt',
      'fe2o3': 'Fe2O3_wt',
      'fe2o3(wt%)': 'Fe2O3_wt',
      'fe2o3 wt%': 'Fe2O3_wt',
      'feo': 'FeO_wt',
      'feo(wt%)': 'FeO_wt',
      'feo wt%': 'FeO_wt',
      'mno': 'MnO_wt',
      'mno(wt%)': 'MnO_wt',
      'mno wt%': 'MnO_wt',
      'mgo': 'MgO_wt',
      'mgo(wt%)': 'MgO_wt',
      'mgo wt%': 'MgO_wt',
      'cao': 'CaO_wt',
      'cao(wt%)': 'CaO_wt',
      'cao wt%': 'CaO_wt',
      'na2o': 'Na2O_wt',
      'na2o(wt%)': 'Na2O_wt',
      'na2o wt%': 'Na2O_wt',
      'k2o': 'K2O_wt',
      'k2o(wt%)': 'K2O_wt',
      'k2o wt%': 'K2O_wt',
      'p2o5': 'P2O5_wt',
      'p2o5(wt%)': 'P2O5_wt',
      'p2o5 wt%': 'P2O5_wt',

      // Ratio variations
      'zr nb ratio': 'Zr_Nb_Ratio',
      'zr/nb': 'Zr_Nb_Ratio',
      'cr ni ratio': 'Cr_Ni_Ratio',
      'cr/ni': 'Cr_Ni_Ratio',
      'ba rb ratio': 'Ba_Rb_Ratio',
      'ba/rb': 'Ba_Rb_Ratio',
      'la sm ratio': 'La_Sm_Ratio',
      'la/sm': 'La_Sm_Ratio',
      'la yb ratio': 'La_Yb_Ratio',
      'la/yb': 'La_Yb_Ratio',
      'nb yb ratio': 'Nb_Yb_Ratio',
      'nb/yb': 'Nb_Yb_Ratio',
      'sm yb ratio': 'Sm_Yb_Ratio',
      'sm/yb': 'Sm_Yb_Ratio',
      'th yb ratio': 'Th_Yb_Ratio',
      'th/yb': 'Th_Yb_Ratio',
      'ti v ratio': 'Ti_V_Ratio',
      'ti/v': 'Ti_V_Ratio',

      // Classification columns
      'auto classification': 'Auto_Classification',
      'classification': 'Auto_Classification',
      'auto confidence': 'Auto_Confidence',
      'confidence': 'Auto_Confidence',
      'flag for review': 'Flag_For_Review',
      'flag': 'Flag_For_Review',
      'display color': 'Display_Color',
      'weathering state': 'Weathering_State',

      // Notes - we'll handle specially
      'notes': 'Notes',
      'note': 'Notes',
      'comment': 'Notes',

      // Metadata
      'source': '_source',
      'synced': '_synced',
      'imported_via': '_imported_via',
      'imported_at': '_imported_at'
=======
      serialPort: null
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    };

    // ========== API CLIENT ==========
    const api = {
      headers(extra = {}) {
        const h = { 'Content-Type': 'application/json', ...extra };
        if (STATE.token) h['X-Auth-Token'] = STATE.token;
        h['ngrok-skip-browser-warning'] = 'true';
        return h;
      },
      async get(path) {
        const r = await fetch(STATE.baseUrl + path, { headers: this.headers() });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
      },
      async post(path, body) {
        const r = await fetch(STATE.baseUrl + path, {
          method: 'POST',
          headers: this.headers(),
          body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
      },
<<<<<<< HEAD
      // FIX: Added missing PUT method
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      async put(path, body) {
        const r = await fetch(STATE.baseUrl + path, {
          method: 'PUT',
          headers: this.headers(),
          body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
      },
<<<<<<< HEAD
      async postFormData(path, formData) {
        const headers = { 'ngrok-skip-browser-warning': 'true' };
        if (STATE.token) headers['X-Auth-Token'] = STATE.token;
        const r = await fetch(STATE.baseUrl + path, {
          method: 'POST',
          headers: headers,
          body: formData
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
      },
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      async delete(path) {
        const r = await fetch(STATE.baseUrl + path, {
          method: 'DELETE',
          headers: this.headers()
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
      },
      async uploadImage(file, sampleId) {
        const fd = new FormData();
        fd.append('image', file);
        if (sampleId) fd.append('sample_id', sampleId);
<<<<<<< HEAD
        return this.postFormData('/api/image', fd);
=======
        const headers = { 'ngrok-skip-browser-warning': 'true' };
        if (STATE.token) headers['X-Auth-Token'] = STATE.token;
        const r = await fetch(STATE.baseUrl + '/api/image', {
          method: 'POST',
          headers: headers,
          body: fd
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      },
      downloadCSV() {
        fetch(STATE.baseUrl + '/api/samples/export/csv', { headers: this.headers() })
          .then(r => r.blob())
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `samples_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          })
          .catch(e => toast('Download failed', 'error'));
      }
    };
<<<<<<< HEAD
=======

>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    // ========== TOAST ==========
    function toast(msg, type = 'info', duration = 3000) {
      const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.innerHTML = `<span>${icons[type] || '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
      document.getElementById('toast-container').prepend(el);
      setTimeout(() => el.remove(), duration);
    }

    // ========== UTILITIES ==========
    function esc(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"]/g, function(m) {
        if (m === '&') return '&amp;';
        if (m === '<') return '&lt;';
        if (m === '>') return '&gt;';
        if (m === '"') return '&quot;';
        return m;
      });
    }

    function closeSheet() {
      document.getElementById('sample-sheet').classList.add('hidden');
    }

<<<<<<< HEAD
    // ========== COLUMN NORMALIZER ==========
    function normalizeColumnName(originalName) {
      if (!originalName) return originalName;

      // Convert to lowercase and trim
      const clean = originalName.toString().toLowerCase().trim();

      // Direct lookup
      if (COLUMN_NORMALIZATION[clean]) {
        return COLUMN_NORMALIZATION[clean];
      }

      // Try without spaces and underscores
      const noSpaces = clean.replace(/[\s_]/g, '');
      if (COLUMN_NORMALIZATION[noSpaces]) {
        return COLUMN_NORMALIZATION[noSpaces];
      }

      // If it contains 'ppm' but not in our map, keep as is but ensure _ppm suffix
      if (clean.includes('ppm') && !clean.includes('_ppm')) {
        const element = clean.replace('ppm', '').replace(/[\s_]/g, '').toUpperCase();
        return `${element}_ppm`;
      }

      // If it contains 'wt%' or 'wt', ensure _wt suffix
      if (clean.includes('wt%') || clean.includes('wt')) {
        const oxide = clean.replace(/wt%|wt|[\s_]/g, '').toUpperCase();
        return `${oxide}_wt`;
      }

      // If it contains 'ratio', ensure _Ratio suffix
      if (clean.includes('ratio')) {
        const parts = clean.replace('ratio', '').replace(/[\s_]/g, '').split(/[\/\\]/);
        if (parts.length >= 2) {
          return `${parts[0]}_${parts[1]}_Ratio`;
        }
      }

      // Return original if no match (but clean it up)
      return originalName.replace(/\s+/g, '_').replace(/[()]/g, '');
    }

    function normalizeSampleRow(row) {
      const normalized = {};
      const notesParts = [];

      for (let [key, value] of Object.entries(row)) {
        if (value === undefined || value === null || value === '') continue;

        const normalizedKey = normalizeColumnName(key);
        const stringValue = String(value).trim();

        // Try to convert to number if it looks numeric
        let numericValue = null;
        if (/^-?\d*\.?\d+$/.test(stringValue)) {
          numericValue = parseFloat(stringValue);
        }

        // Handle special cases
        if (normalizedKey === 'Notes') {
          notesParts.push(stringValue);
        } else if (normalizedKey === '_source' || normalizedKey === '_synced' || normalizedKey === '_imported_via' || normalizedKey === '_imported_at') {
          // Keep metadata fields as-is
          normalized[normalizedKey] = stringValue;
        } else if (normalizedKey.includes('_ppm') || normalizedKey.includes('_wt') || normalizedKey.includes('_Ratio')) {
          // These are numeric fields
          normalized[normalizedKey] = numericValue !== null ? numericValue : stringValue;
        } else if (COLUMN_NORMALIZATION[normalizedKey.toLowerCase()] ||
                   normalizedKey === 'Sample_ID' ||
                   normalizedKey === 'Auto_Classification' ||
                   normalizedKey === 'Auto_Confidence' ||
                   normalizedKey === 'Flag_For_Review' ||
                   normalizedKey === 'Display_Color' ||
                   normalizedKey === 'Weathering_State') {
          // Known non-numeric fields
          normalized[normalizedKey] = numericValue !== null ? numericValue : stringValue;
        } else {
          // Unknown fields go to notes
          notesParts.push(`${key}: ${stringValue}`);
        }
      }

      // Ensure Sample_ID exists
      if (!normalized.Sample_ID) {
        normalized.Sample_ID = `IMP_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      }

      // Add combined notes
      if (notesParts.length > 0) {
        normalized.Notes = notesParts.join(' | ');
      }

      return normalized;
    }

    // ========== TOGGLE SINGLE SAMPLE CLASSIFICATION ==========
    async function classifySingleSample(sampleId) {
      const schemeId = document.getElementById('tablet-scheme-select')?.value || document.getElementById('scheme-select')?.value;
      if (!schemeId) { toast('Select a scheme first', 'warning'); return; }

      try {
        toast('Classifying sample...', 'info', 2000);

        // First get the sample
        const sample = await api.get(`/api/samples/${encodeURIComponent(sampleId)}`);

        // Then classify it using the classify/sample endpoint
        const result = await api.post('/api/classify/sample', {
          ...sample,
          scheme_id: schemeId
        });

        // Update the sample in the database using PUT
        const updates = {
          Auto_Classification: result.classification,
          Auto_Confidence: result.confidence,
          Display_Color: result.color,
          Flag_For_Review: result.confidence < 0.7 // Flag if confidence < 70%
        };

        await api.put(`/api/samples/${encodeURIComponent(sampleId)}`, updates);

        toast(`Classified: ${result.classification}`, 'success');

        // Refresh the view
        if (window.innerWidth >= 768) loadTabletSamples(STATE.currentPage);
        else loadPhoneSamples(STATE.currentPage);

      } catch (e) {
        console.error('Classification error:', e);
        toast('Classification failed: ' + e.message, 'error');
      }
    }
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    // ========== NAVIGATION ==========
    function showView(viewId) {
      // Hide all main content views
      document.querySelectorAll('.main-content').forEach(v => v.classList.add('hidden'));

      // Show the requested view
      const targetView = document.getElementById(viewId + '-view');
      if (targetView) targetView.classList.remove('hidden');

      // Update navigation active states
      document.querySelectorAll('.nav-item, .tablet-nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll(`.nav-item[data-view="${viewId}"], .tablet-nav-item[data-view="${viewId}"]`).forEach(n => n.classList.add('active'));

      // Load data as needed
      if (viewId === 'samples') {
        if (window.innerWidth >= 768) loadTabletSamples(STATE.currentPage);
        else loadPhoneSamples(STATE.currentPage);
      }
<<<<<<< HEAD
      // Schemes are now loaded on app start, not just when classify view opens
=======
      if (viewId === 'classify') loadSchemes();
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    }

    document.querySelectorAll('.nav-item, .tablet-nav-item').forEach(btn => {
      btn.addEventListener('click', () => showView(btn.dataset.view));
    });

    // ========== CONNECTION ==========
    function showConnect() {
      document.getElementById('connect-screen').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
      STATE.connected = false;
    }

    function showApp() {
      document.getElementById('connect-screen').classList.add('hidden');
      document.getElementById('splash').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      showView('samples');
      toast('Connected', 'success');
    }

    document.getElementById('test-connection').addEventListener('click', async () => {
      const url = document.getElementById('server-url').value.trim().replace(/\/$/, '');
      const token = document.getElementById('auth-token').value.trim();
      const statusDiv = document.getElementById('connection-status');
      statusDiv.innerHTML = '<div class="spinner"></div> Testing‚Ä¶';
      try {
        const r = await fetch(url + '/ping', {
          headers: token ? { 'X-Auth-Token': token, 'ngrok-skip-browser-warning': 'true' } : { 'ngrok-skip-browser-warning': 'true' },
          signal: AbortSignal.timeout(5000)
        });
        const responseText = await r.text();
        if (!r.ok) {
          statusDiv.innerHTML = `‚úó HTTP ${r.status}`;
          return;
        }
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          statusDiv.innerHTML = `‚úó Invalid JSON`;
          return;
        }
        statusDiv.innerHTML = `‚úì Connected ¬∑ ${data.server || 'OK'}`;
        STATE.baseUrl = url;
        STATE.token = token;
      } catch (e) {
        statusDiv.innerHTML = `‚úó ${e.message}`;
      }
    });

    document.getElementById('connect-btn').addEventListener('click', async () => {
      const url = document.getElementById('server-url').value.trim().replace(/\/$/, '');
      const token = document.getElementById('auth-token').value.trim();
      if (!url) { toast('Enter server URL', 'warning'); return; }
      STATE.baseUrl = url;
      STATE.token = token;
      try {
        await api.get('/ping');
        localStorage.setItem('ft_url', url);
        localStorage.setItem('ft_token', token);
        document.getElementById('settings-url').innerText = url;
        document.getElementById('settings-token').innerText = token ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'None';
        document.getElementById('splash').classList.add('hidden');
        document.getElementById('connect-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
<<<<<<< HEAD

        // Load schemes immediately after connection
        await loadSchemes();

=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
        showView('samples');
        toast('Connected', 'success');
      } catch (e) {
        toast('Connection failed: ' + e.message, 'error');
      }
    });

    document.getElementById('disconnect').addEventListener('click', () => {
      STATE.connected = false;
      localStorage.removeItem('ft_url');
      localStorage.removeItem('ft_token');
      document.getElementById('app').classList.add('hidden');
      document.getElementById('connect-screen').classList.remove('hidden');
    });

    (function() {
      const url = localStorage.getItem('ft_url');
      const token = localStorage.getItem('ft_token');
      if (url) {
        document.getElementById('server-url').value = url;
        document.getElementById('auth-token').value = token || '';
      }
    })();

    // ========== PHONE SAMPLES ==========
    async function loadPhoneSamples(page = 0) {
      STATE.currentPage = page;
      const listEl = document.getElementById('sample-list');
      if (!listEl) return;
      listEl.innerHTML = '<div class="spinner"></div>';
      try {
        const q = STATE.searchQuery ? `&search=${encodeURIComponent(STATE.searchQuery)}` : '';
        const data = await api.get(`/api/samples?page=${page}&size=${STATE.pageSize}${q}`);
        STATE.totalPages = data.pages;
        STATE.totalSamples = data.total;
        renderPhoneSamples(data.samples || []);
        document.getElementById('sample-count').innerText = data.total;
        document.getElementById('page-info').innerText = `Page ${data.page+1} of ${data.pages}`;
        document.getElementById('prev-page').disabled = data.page === 0;
        document.getElementById('next-page').disabled = data.page >= data.pages - 1;
      } catch(e) {
        listEl.innerHTML = `<div class="card text-center text-muted">Error loading samples: ${e.message}</div>`;
      }
    }

    function renderPhoneSamples(samples) {
      const listEl = document.getElementById('sample-list');
      if (!samples.length) {
        listEl.innerHTML = '<div class="card text-center text-muted">No samples</div>';
        return;
      }
      listEl.innerHTML = samples.map(s => {
        const id = s.Sample_ID || '‚Äî';
        const cls = s.Auto_Classification || s.TAS_Classification || '';
        const notes = (s.Notes || '').slice(0, 60) || `${Object.keys(s).length} fields`;
        return `<div class="sample-item" onclick="openSample('${esc(id)}')">
          <div style="flex:1">
            <div class="sample-id">${esc(id)}</div>
            <div class="sample-meta">${esc(notes)}</div>
          </div>
          ${cls ? `<span class="sample-class">${esc(cls.slice(0,20))}</span>` : ''}
          <span style="color:var(--text-muted);">‚Ä∫</span>
        </div>`;
      }).join('');
    }

<<<<<<< HEAD
    // ========== TABLET SAMPLES WITH DYNAMIC COLUMNS ==========
=======
    // ========== TABLET SAMPLES ==========
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    async function loadTabletSamples(page = 0) {
      STATE.currentPage = page;
      try {
        const query = document.getElementById('tablet-search').value;
        const qs = query ? `&search=${encodeURIComponent(query)}` : '';
        const data = await api.get(`/api/samples?page=${page}&size=${STATE.pageSize}${qs}`);
        STATE.totalPages = data.pages;
        STATE.totalSamples = data.total;
<<<<<<< HEAD

        // Update columns if needed
        updateAllColumns(data.samples || []);

=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
        renderTabletSamples(data.samples || []);
        document.getElementById('tablet-page-info').innerText = `Page ${data.page+1} of ${data.pages}`;
        document.getElementById('tablet-prev-page').disabled = data.page === 0;
        document.getElementById('tablet-next-page').disabled = data.page >= data.pages - 1;
        updateHUD(data.samples || []);
      } catch(e) {
        toast('Failed to load samples', 'error');
      }
    }

<<<<<<< HEAD
    function updateAllColumns(samples) {
      // Extract all unique column names from samples
      const columnSet = new Set();
      samples.forEach(sample => {
        Object.keys(sample).forEach(key => columnSet.add(key));
      });

      // Convert to array and sort (with Sample_ID always first)
      const newColumns = Array.from(columnSet);

      // Define priority order
      const priorityOrder = [
        'Sample_ID',
        'Auto_Classification',
        'Auto_Confidence',
        'TAS_Classification',
        'Weathering_State',
        'Notes',
        'Date',
        'Latitude',
        'Longitude'
      ];

      // Start with priority columns that exist
      const sortedColumns = [];
      priorityOrder.forEach(col => {
        if (newColumns.includes(col)) {
          sortedColumns.push(col);
          newColumns.splice(newColumns.indexOf(col), 1);
        }
      });

      // Sort remaining columns alphabetically
      newColumns.sort();
      sortedColumns.push(...newColumns);

      STATE.allColumns = sortedColumns;
      STATE.visibleColumns = sortedColumns; // Show all columns by default
    }

    function renderTabletSamples(samples) {
      const headerRow = document.getElementById('header-row');
      const tableBody = document.getElementById('table-body');

      if (!samples.length) {
        headerRow.innerHTML = '<th>No samples</th>';
        tableBody.innerHTML = '<tr><td class="text-center text-muted">Load samples to see data</td></tr>';
        return;
      }

      // Render headers
      headerRow.innerHTML = STATE.visibleColumns.map(col =>
        `<th>${escapeHeader(col)}</th>`
      ).join('');

      // Render rows
      tableBody.innerHTML = samples.map(sample => {
        const rowHtml = '<tr onclick="openSample(\'' + esc(sample.Sample_ID || '') + '\')">' +
          STATE.visibleColumns.map(col => {
            let value = sample[col];
            if (value === undefined || value === null || value === '') {
              return '<td>‚Äî</td>';
            }

            // Format numbers nicely
            if (typeof value === 'number') {
              if (Math.abs(value) < 0.01 || Math.abs(value) > 10000) {
                value = value.toExponential(2);
              } else {
                value = value.toFixed(2);
              }
            }

            // Special styling for classification columns
            if (col.includes('Classification') && value) {
              return `<td><span class="sample-class">${esc(String(value))}</span></td>`;
            }

            return `<td>${esc(String(value))}</td>`;
          }).join('') +
        '</tr>';
        return rowHtml;
      }).join('');
    }

    function escapeHeader(header) {
      return header.replace(/_/g, ' ');
    }

=======
    function renderTabletSamples(samples) {
      const tbody = document.getElementById('sample-table-body');
      if (!samples.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No samples</td></tr>';
        return;
      }
      tbody.innerHTML = samples.map(s => {
        const id = s.Sample_ID || '‚Äî';
        const cls = s.Auto_Classification || s.TAS_Classification || '';
        const conf = s.Auto_Confidence ? (typeof s.Auto_Confidence === 'number' ? (s.Auto_Confidence*100).toFixed(0) : s.Auto_Confidence) : '‚Äî';
        return `<tr onclick="openSample('${esc(id)}')">
          <td class="sample-id">${esc(id)}</td>
          <td>${cls ? `<span class="sample-class">${esc(cls)}</span>` : '‚Äî'}</td>
          <td>${conf}</td>
        </tr>`;
      }).join('');
    }

>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    function updateHUD(samples) {
      const hud = document.getElementById('hud-list');
      if (!hud) return;
      if (!samples.length) {
        hud.innerHTML = '<li class="text-muted">No samples</li>';
        return;
      }
      hud.innerHTML = samples.map(s => {
<<<<<<< HEAD
        const id = s.Sample_ID || '‚Äî';
        const shortId = id.slice(-6);
        const cls = s.Auto_Classification || s.TAS_Classification || 'UNCLASSIFIED';
        const conf = s.Auto_Confidence ? (typeof s.Auto_Confidence === 'number' ? (s.Auto_Confidence*100).toFixed(0) : s.Auto_Confidence) : '‚Äî';

        return `<li class="hud-item" onclick="classifySingleSample('${esc(id)}')" title="Click to classify this sample">
          <span class="hud-class">${esc(cls)}</span>
          <span class="hud-id">${esc(shortId)}</span>
          <span class="hud-conf">${conf}</span>
        </li>`;
=======
        const id = (s.Sample_ID || '‚Äî').slice(-6);
        const cls = s.Auto_Classification || s.TAS_Classification || 'UNCLASSIFIED';
        const conf = s.Auto_Confidence ? (typeof s.Auto_Confidence === 'number' ? (s.Auto_Confidence*100).toFixed(0) : s.Auto_Confidence) : '‚Äî';
        return `<li class="hud-item"><span class="hud-class">${esc(cls)}</span><span class="hud-id">${esc(id)}</span><span class="hud-conf">${conf}</span></li>`;
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
      }).join('');
    }

    // ========== SAMPLE DETAIL ==========
    window.openSample = async function(id) {
      try {
        const sample = await api.get(`/api/samples/${encodeURIComponent(id)}`);
        STATE.currentSample = sample;
        document.getElementById('sheet-sample-id').innerText = sample.Sample_ID || id;
        let html = '<table style="width:100%; border-collapse:collapse;">';
<<<<<<< HEAD

        // Sort keys for better display
        const sortedKeys = Object.keys(sample).sort();

        for (let k of sortedKeys) {
          if (k === 'Sample_ID') continue;
          const v = sample[k];
          if (v === null || v === '') continue;

          let displayValue = String(v);
          if (typeof v === 'number') {
            if (Math.abs(v) < 0.01 || Math.abs(v) > 10000) {
              displayValue = v.toExponential(2);
            } else {
              displayValue = v.toFixed(2);
            }
          }

          html += `<tr><td style="padding:6px 0; color:var(--text-muted);">${k}</td>
                   <td style="padding:6px 0;">${esc(displayValue)}</td></tr>`;
=======
        for (let [k,v] of Object.entries(sample)) {
          if (k === 'Sample_ID') continue;
          if (v === null || v === '') continue;
          html += `<tr><td style="padding:6px 0; color:var(--text-muted);">${k}</td><td style="padding:6px 0;">${esc(String(v))}</td></tr>`;
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
        }
        html += '</table>';
        document.getElementById('sheet-content').innerHTML = html;
        document.getElementById('sample-sheet').classList.remove('hidden');
      } catch (e) {
        toast('Error loading sample', 'error');
      }
    };

<<<<<<< HEAD
    // ========== CLASSIFICATION SCHEMES - LOADED ON START ==========
    async function loadSchemes() {
      const selects = ['scheme-select', 'tablet-scheme-select'];

      // Set loading state
      for (let id of selects) {
        const sel = document.getElementById(id);
        if (!sel) continue;
        sel.innerHTML = '<option>Loading schemes...</option>';
      }

      try {
        const schemes = await api.get('/api/classify/schemes');
        STATE.schemes = schemes;
        STATE.schemesLoaded = true;

        // Update all scheme selects
        for (let id of selects) {
          const sel = document.getElementById(id);
          if (!sel) continue;

          if (!schemes.length) {
            sel.innerHTML = '<option value="">No schemes available</option>';
          } else {
            sel.innerHTML = schemes.map(s =>
              `<option value="${s.id}">${s.icon || 'üìä'} ${s.name}</option>`
            ).join('');

            // Select first scheme by default
            sel.selectedIndex = 0;
            STATE.selectedScheme = schemes[0].id;
          }
        }

        console.log(`Loaded ${schemes.length} classification schemes`);
      } catch (e) {
        console.error('Failed to load schemes:', e);
        for (let id of selects) {
          const sel = document.getElementById(id);
          if (sel) sel.innerHTML = '<option value="">Error loading schemes</option>';
        }
      }
    }

    async function classifyAll() {
      const schemeId = document.getElementById('tablet-scheme-select')?.value || document.getElementById('scheme-select')?.value;
      if (!schemeId) { toast('Select a scheme', 'warning'); return; }
      try {
        const res = await api.post(`/api/classify/apply/${schemeId}`, {});
        toast(`Classified ${res.count} samples`, 'success');
        if (window.innerWidth >= 768) loadTabletSamples(STATE.currentPage);
        else loadPhoneSamples(STATE.currentPage);
      } catch (e) {
        toast('Classification failed: ' + e.message, 'error');
      }
    }

    // ========== IMPORT FUNCTIONALITY ==========
    const importManager = {
      files: [],
      currentFileIndex: 0,
      totalFiles: 0,
      successCount: 0,
      errorCount: 0,

      init() {
        const importZone = document.getElementById('import-zone');
        const fileInput = document.getElementById('import-file-input');

        if (importZone && fileInput) {
          importZone.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        }
      },

      handleFileSelect(event) {
        this.files = Array.from(event.target.files);
        if (this.files.length === 0) return;

        this.totalFiles = this.files.length;
        this.currentFileIndex = 0;
        this.successCount = 0;
        this.errorCount = 0;

        // Show progress container
        document.getElementById('import-progress-container').style.display = 'block';
        this.updateProgress();

        // Start processing first file
        this.processNextFile();
      },

      updateProgress() {
        const percent = Math.round((this.currentFileIndex / this.totalFiles) * 100);
        document.getElementById('import-progress-fill').style.width = percent + '%';
        document.getElementById('import-percent').textContent = percent + '%';
        document.getElementById('import-status').textContent =
          `Processing ${this.currentFileIndex + 1}/${this.totalFiles}: ${this.files[this.currentFileIndex].name}`;
      },

      async processNextFile() {
        if (this.currentFileIndex >= this.totalFiles) {
          // All files processed
          document.getElementById('import-progress-container').style.display = 'none';
          toast(`Import complete: ${this.successCount} successful, ${this.errorCount} failed`,
                this.errorCount === 0 ? 'success' : 'warning');

          // Refresh the samples view
          if (window.innerWidth >= 768) loadTabletSamples(0);
          else loadPhoneSamples(0);

          // Clear file input
          document.getElementById('import-file-input').value = '';
          return;
        }

        const file = this.files[this.currentFileIndex];
        this.updateProgress();

        try {
          let rows = [];
          const fileName = file.name.toLowerCase();

          // Parse based on file extension
          if (fileName.endsWith('.csv')) {
            rows = await this.parseCSV(file);
          } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            rows = await this.parseExcel(file);
          } else if (fileName.endsWith('.txt') || fileName.endsWith('.mca') || fileName.endsWith('.spec')) {
            rows = await this.parseSpectrum(file);
          } else {
            throw new Error('Unsupported file format');
          }

          if (rows.length > 0) {
            // Normalize each row
            const normalizedRows = rows.map(row => normalizeSampleRow(row));

            // Send to API
            await api.post('/api/samples', normalizedRows);
            this.successCount++;
          } else {
            this.errorCount++;
          }
        } catch (e) {
          console.error('Import error:', e);
          this.errorCount++;
          toast(`Error importing ${file.name}: ${e.message}`, 'error');
        }

        this.currentFileIndex++;
        this.processNextFile();
      },

      parseCSV(file) {
        return new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              resolve(results.data);
            },
            error: (error) => reject(error)
          });
        });
      },

      parseExcel(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

              if (rows.length < 2) {
                resolve([]);
                return;
              }

              const headers = rows[0].map(h => String(h).trim());
              const result = [];

              for (let i = 1; i < rows.length; i++) {
                const row = {};
                let hasData = false;

                for (let j = 0; j < headers.length; j++) {
                  if (rows[i][j] !== undefined && rows[i][j] !== null && String(rows[i][j]).trim() !== '') {
                    row[headers[j]] = String(rows[i][j]).trim();
                    hasData = true;
                  }
                }

                if (hasData) {
                  result.push(row);
                }
              }

              resolve(result);
            } catch (e) {
              reject(e);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      },

      parseSpectrum(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const content = e.target.result;
              const lines = content.split('\n');
              const x = [];
              const y = [];

              for (let line of lines) {
                line = line.trim();
                if (!line || line.startsWith('#')) continue;

                const parts = line.split(/\s+/);
                if (parts.length >= 2) {
                  const xVal = parseFloat(parts[0]);
                  const yVal = parseFloat(parts[1]);
                  if (!isNaN(xVal) && !isNaN(yVal)) {
                    x.push(xVal);
                    y.push(yVal);
                  }
                }
              }

              if (x.length > 0) {
                const row = {
                  Sample_ID: file.name.replace(/\.[^/.]+$/, ""),
                  Spectrum_Data: JSON.stringify({x, y}),
                  Channel_Count: x.length,
                  Notes: `Imported spectrum: ${file.name}`
                };
                resolve([row]);
              } else {
                resolve([]);
              }
            } catch (e) {
              reject(e);
            }
          };
          reader.onerror = reject;
          reader.readAsText(file);
        });
      }
    };

=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    // Safe event listeners - executed after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const sheetClose = document.getElementById('sheet-close');
      if (sheetClose) sheetClose.addEventListener('click', closeSheet);

      const sampleSheet = document.getElementById('sample-sheet');
      if (sampleSheet) {
        sampleSheet.addEventListener('click', function(e) {
          if (e.target === this) closeSheet();
        });
      }

      const sheetDelete = document.getElementById('sheet-delete');
      if (sheetDelete) {
        sheetDelete.addEventListener('click', async () => {
          if (!STATE.currentSample) return;
          const id = STATE.currentSample.Sample_ID;
          if (!confirm(`Delete sample ${id}?`)) return;
          try {
            await api.delete(`/api/samples/${encodeURIComponent(id)}`);
            toast('Sample deleted', 'success');
            closeSheet();
            if (window.innerWidth >= 768) loadTabletSamples(STATE.currentPage);
            else loadPhoneSamples(STATE.currentPage);
          } catch (e) {
            toast('Delete failed', 'error');
          }
        });
      }

      const sheetClassify = document.getElementById('sheet-classify');
      if (sheetClassify) {
        sheetClassify.addEventListener('click', () => {
          closeSheet();
          showView('classify');
        });
      }
<<<<<<< HEAD

      // Initialize import manager
      importManager.init();
=======
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    });

    // ========== SEARCH & PAGINATION (phone) ==========
    let searchTimer;
    document.getElementById('sample-search')?.addEventListener('input', e => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        STATE.searchQuery = e.target.value;
        STATE.currentPage = 0;
        loadPhoneSamples(0);
      }, 400);
    });
    document.getElementById('prev-page')?.addEventListener('click', () => {
      if (STATE.currentPage > 0) loadPhoneSamples(STATE.currentPage - 1);
    });
    document.getElementById('next-page')?.addEventListener('click', () => {
      if (STATE.currentPage < STATE.totalPages - 1) loadPhoneSamples(STATE.currentPage + 1);
    });

    // Tablet search/pagination
    document.getElementById('tablet-search')?.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => loadTabletSamples(0), 400);
    });
    document.getElementById('tablet-prev-page')?.addEventListener('click', () => {
      if (STATE.currentPage > 0) loadTabletSamples(STATE.currentPage - 1);
    });
    document.getElementById('tablet-next-page')?.addEventListener('click', () => {
      if (STATE.currentPage < STATE.totalPages - 1) loadTabletSamples(STATE.currentPage + 1);
    });

    // ========== ADD SAMPLE (phone) ==========
    document.getElementById('gps-button').addEventListener('click', () => {
      if (!navigator.geolocation) {
        toast('GPS not supported', 'warning');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          STATE.gps.lat = pos.coords.latitude.toFixed(6);
          STATE.gps.lon = pos.coords.longitude.toFixed(6);
          document.getElementById('gps-status').innerText = `${STATE.gps.lat}, ${STATE.gps.lon}`;
          toast('GPS acquired', 'success');
        },
        err => {
          document.getElementById('gps-status').innerText = 'Error: ' + err.message;
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    document.getElementById('submit-sample').addEventListener('click', async () => {
      const id = document.getElementById('add-sample-id').value.trim();
      if (!id) { toast('Sample ID required', 'warning'); return; }
      const notes = document.getElementById('add-notes').value.trim();
      const sample = { Sample_ID: id };
      if (notes) sample.Notes = notes;
      if (STATE.gps.lat) sample.Latitude = parseFloat(STATE.gps.lat);
      if (STATE.gps.lon) sample.Longitude = parseFloat(STATE.gps.lon);
      try {
        await api.post('/api/samples', sample);
        toast('Sample added', 'success');
        document.getElementById('add-sample-id').value = '';
        document.getElementById('add-notes').value = '';
        STATE.gps.lat = STATE.gps.lon = null;
        document.getElementById('gps-status').innerText = 'Not acquired';
        showView('samples');
        if (window.innerWidth >= 768) loadTabletSamples(0);
        else loadPhoneSamples(0);
      } catch (e) {
        toast('Submit failed: ' + e.message, 'error');
      }
    });

<<<<<<< HEAD
    // ========== TABLET ADD ROW ==========
    document.getElementById('tablet-add-row')?.addEventListener('click', async () => {
      const id = document.getElementById('tablet-sample-id').value.trim();
      if (!id) { toast('Sample ID required', 'warning'); return; }
      const notes = document.getElementById('tablet-notes').value.trim();
      const sample = { Sample_ID: id };
      if (notes) sample.Notes = notes;
      try {
        await api.post('/api/samples', sample);
        toast('Sample added', 'success');
        document.getElementById('tablet-sample-id').value = '';
        document.getElementById('tablet-notes').value = '';
        loadTabletSamples(STATE.currentPage);
      } catch (e) {
        toast('Submit failed: ' + e.message, 'error');
      }
    });

    // ========== CLASSIFICATION ==========
    document.getElementById('classify-all')?.addEventListener('click', classifyAll);
    document.getElementById('tablet-classify-all')?.addEventListener('click', classifyAll);
    window.classifySingleSample = classifySingleSample;
=======
    // ========== CLASSIFICATION ==========
    async function loadSchemes() {
      const selects = ['scheme-select', 'tablet-scheme-select'];
      for (let id of selects) {
        const sel = document.getElementById(id);
        if (!sel) continue;
        sel.innerHTML = '<option>Loading...</option>';
      }
      try {
        const schemes = await api.get('/api/classify/schemes');
        STATE.schemes = schemes;
        for (let id of selects) {
          const sel = document.getElementById(id);
          if (!sel) continue;
          sel.innerHTML = schemes.map(s => `<option value="${s.id}">${s.icon || 'üìä'} ${s.name}</option>`).join('');
        }
      } catch (e) {
        for (let id of selects) {
          const sel = document.getElementById(id);
          if (sel) sel.innerHTML = '<option>Error</option>';
        }
      }
    }

    async function classifyAll() {
      const schemeId = document.getElementById('tablet-scheme-select')?.value || document.getElementById('scheme-select')?.value;
      if (!schemeId) { toast('Select a scheme', 'warning'); return; }
      try {
        const res = await api.post(`/api/classify/apply/${schemeId}`, {});
        toast(`Classified ${res.count} samples`, 'success');
        if (window.innerWidth >= 768) loadTabletSamples(STATE.currentPage);
        else loadPhoneSamples(STATE.currentPage);
      } catch (e) {
        toast('Classification failed: ' + e.message, 'error');
      }
    }

    document.getElementById('classify-all')?.addEventListener('click', classifyAll);
    document.getElementById('tablet-classify-all')?.addEventListener('click', classifyAll);
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377

    // ========== CAMERA ==========
    const cameraInput = document.getElementById('camera-input');
    const previewContainer = document.getElementById('image-preview-container');
    const cameraZone = document.getElementById('camera-zone');
    const imagePreview = document.getElementById('image-preview');
    let selectedFile = null;

    cameraInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = ev => {
        imagePreview.src = ev.target.result;
        cameraZone.classList.add('hidden');
        previewContainer.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('cancel-photo').addEventListener('click', () => {
      selectedFile = null;
      cameraInput.value = '';
      previewContainer.classList.add('hidden');
      cameraZone.classList.remove('hidden');
    });

    document.getElementById('upload-photo').addEventListener('click', async () => {
      if (!selectedFile) return;
      const sampleId = document.getElementById('photo-sample-id').value.trim();
      const btn = document.getElementById('upload-photo');
      btn.disabled = true; btn.innerText = 'Uploading...';
      try {
        const res = await api.uploadImage(selectedFile, sampleId);
        toast('Photo uploaded', 'success');
        document.getElementById('cancel-photo').click();
      } catch (e) {
        toast('Upload failed: ' + e.message, 'error');
      } finally {
        btn.disabled = false; btn.innerText = 'Upload';
      }
    });

    // ========== HARDWARE MANAGER ==========
    class HardwareManager {
      constructor() {
        this.currentDevice = null;
        this.statusEl = document.getElementById('hardware-status');
        this.deviceSelect = document.getElementById('hardware-device-select');
        this.connectBtn = document.getElementById('hardware-connect-btn');
        this.readBtn = document.getElementById('hardware-read-btn');
        this.bleDeviceList = document.getElementById('bluetooth-device-list');
        this.bleSelect = document.getElementById('ble-device-select');
        this.gpsWatcher = null;
        this.bleCharacteristic = null;
        this.serialReader = null;
        this.init();
      }

      init() {
        this.connectBtn.addEventListener('click', () => this.connect());
        this.readBtn.addEventListener('click', () => this.read());
        this.updateDeviceOptions();
      }

      updateDeviceOptions() {
        const options = this.deviceSelect.options;
        for (let opt of options) {
          if (opt.value === 'gps' && !STATE.hardware.gps) opt.disabled = true;
          else if (opt.value === 'camera-barcode' && !STATE.hardware.cameraBarcode) opt.disabled = true;
          else if (opt.value === 'ble-caliper' && !STATE.hardware.bleCaliper) opt.disabled = true;
          else if (opt.value === 'serial-balance' && !STATE.hardware.serialBalance) opt.disabled = true;
          else if (opt.value === 'mineralogy' && !STATE.hardware.mineralogy) opt.disabled = true;
          else opt.disabled = false;
        }
      }

      async connect() {
        const device = this.deviceSelect.value;
        if (!device) { toast('Select a device', 'warning'); return; }
        this.setStatus(`Connecting to ${device}...`, '#f39c12');

        if (device === 'gps') {
          this.connectGPS();
        } else if (device === 'camera-barcode') {
          toast('Use Camera tab for barcode scanning', 'info');
          this.setStatus('Camera mode ‚Äì use Camera tab', '#3498db');
        } else if (device === 'ble-caliper') {
          await this.connectBLECaliper();
        } else if (device === 'serial-balance') {
          await this.connectSerialBalance();
        } else if (device === 'mineralogy') {
          this.setStatus('Mineralogy mode ‚Äì click Read to load RRUFF', '#3498db');
        }
      }

      async read() {
        const device = this.deviceSelect.value;
        if (!device) { toast('Select a device', 'warning'); return; }

        if (device === 'gps') {
          this.readGPS();
        } else if (device === 'camera-barcode') {
          toast('Use Camera tab', 'info');
        } else if (device === 'ble-caliper') {
          await this.readBLECaliper();
        } else if (device === 'serial-balance') {
          await this.readSerialBalance();
        } else if (device === 'mineralogy') {
          this.runMineralogy();
        }
      }

      setStatus(msg, color = '#e6edf3') {
        if (this.statusEl) {
          this.statusEl.textContent = msg;
          this.statusEl.style.color = color;
        }
      }

      // ---------- GPS ----------
      connectGPS() {
        if (!navigator.geolocation) {
          toast('GPS not supported', 'error');
          this.setStatus('GPS not supported', '#e74c3c');
          return;
        }
        this.setStatus('Acquiring GPS...', '#f39c12');
        this.gpsWatcher = navigator.geolocation.watchPosition(
          pos => {
            STATE.gps.lat = pos.coords.latitude;
            STATE.gps.lon = pos.coords.longitude;
            this.setStatus(`Lat: ${STATE.gps.lat.toFixed(6)}, Lon: ${STATE.gps.lon.toFixed(6)}`, '#2ecc71');
          },
          err => {
            this.setStatus(`GPS error: ${err.message}`, '#e74c3c');
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }

      readGPS() {
        if (STATE.gps.lat && STATE.gps.lon) {
          this.insertIntoCurrentField(`${STATE.gps.lat},${STATE.gps.lon}`);
          toast('GPS coordinates copied', 'success');
        } else {
          toast('No GPS fix yet', 'warning');
        }
      }

      // ---------- BLE Caliper (Sylvac example) ----------
      async connectBLECaliper() {
        if (!navigator.bluetooth) {
          toast('Bluetooth not supported', 'error');
          this.setStatus('Bluetooth not supported', '#e74c3c');
          return;
        }
        try {
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'SYLVAC' }],
            optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
          });
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
          const characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
          this.bleCharacteristic = characteristic;
          this.setStatus(`Connected to ${device.name}`, '#2ecc71');
          STATE.bleDevices.push({ name: device.name, id: device.id });
          await characteristic.startNotifications();
          characteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = new TextDecoder().decode(event.target.value);
            this.setStatus(`Live: ${value} mm`, '#2ecc71');
          });
        } catch (e) {
          this.setStatus(`BLE error: ${e.message}`, '#e74c3c');
        }
      }

      async readBLECaliper() {
        if (!this.bleCharacteristic) {
          toast('Connect to caliper first', 'warning');
          return;
        }
        try {
          const value = await this.bleCharacteristic.readValue();
          const decoded = new TextDecoder().decode(value);
          const match = decoded.match(/([\d.]+)/);
          if (match) {
            const mm = parseFloat(match[1]);
            this.insertIntoCurrentField(mm.toFixed(2));
            toast(`Read: ${mm} mm`, 'success');
          }
        } catch (e) {
          toast('Read failed', 'error');
        }
      }

      // ---------- Serial Balance (Web Serial) ----------
      async connectSerialBalance() {
        if (!navigator.serial) {
          toast('Web Serial not supported (Android/Chrome only)', 'error');
          return;
        }
        try {
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });
          this.serialPort = port;
          this.setStatus('Serial port open', '#2ecc71');
        } catch (e) {
          this.setStatus(`Serial error: ${e.message}`, '#e74c3c');
        }
      }

      async readSerialBalance() {
        if (!this.serialPort) {
          toast('Connect to serial port first', 'warning');
          return;
        }
        const reader = this.serialPort.readable.getReader();
        try {
          const { value, done } = await reader.read();
          if (value) {
            const text = new TextDecoder().decode(value);
            const match = text.match(/([\d.]+)/);
            if (match) {
              const weight = parseFloat(match[1]);
              this.insertIntoCurrentField(weight.toFixed(2));
              toast(`Weight: ${weight} g`, 'success');
            }
          }
        } catch (e) {
          toast('Read failed', 'error');
        } finally {
          reader.releaseLock();
        }
      }

      // ---------- Mineralogy ID (RRUFF) ----------
      async runMineralogy() {
        toast('Downloading RRUFF database...', 'info', 5000);
        this.setStatus('Downloading...', '#f39c12');
        try {
          const url = 'https://www.effemm2.de/spectragryph/databases/RRUFF_Raman_DB_5185excellent_entries_2017_01.zip';
          const response = await fetch(url);
          const blob = await response.blob();
          const zip = await JSZip.loadAsync(blob);
          let minerals = [];
          let count = 0;
          zip.forEach(async (relativePath, file) => {
            if (count++ > 100) return;
            if (file.name.endsWith('.txt')) {
              const content = await file.async('string');
              const lines = content.split('\n');
              const x = [], y = [];
              for (let line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                  x.push(parseFloat(parts[0]));
                  y.push(parseFloat(parts[1]));
                }
              }
              if (x.length > 10) {
                const peaks = [];
                for (let i = 1; i < y.length - 1; i++) {
                  if (y[i] > y[i-1] && y[i] > y[i+1] && y[i] > 0.1 * Math.max(...y)) {
                    peaks.push(x[i]);
                  }
                }
                const name = relativePath.split('/').pop().split('__')[0].replace(/_/g, ' ');
                minerals.push({ name, peaks: peaks.slice(0,5) });
              }
            }
          });
          this.setStatus(`Loaded ${minerals.length} minerals`, '#2ecc71');
          toast(`Mineralogy ready`, 'success');
        } catch (e) {
          this.setStatus(`Error: ${e.message}`, '#e74c3c');
        }
      }

      // ---------- Helper: insert reading into focused input ----------
      insertIntoCurrentField(value) {
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
          active.value = value;
        } else {
          toast(`Reading: ${value}`, 'info');
        }
      }
    }

    // ========== HARDWARE SETTINGS ==========
    document.querySelectorAll('#settings-view input[type=checkbox]').forEach(cb => {
      cb.addEventListener('change', e => {
        const id = e.target.id;
        if (id === 'hw-gps') STATE.hardware.gps = e.target.checked;
        if (id === 'hw-camera-barcode') STATE.hardware.cameraBarcode = e.target.checked;
        if (id === 'hw-ble-caliper') STATE.hardware.bleCaliper = e.target.checked;
        if (id === 'hw-serial-balance') STATE.hardware.serialBalance = e.target.checked;
        if (id === 'hw-mineralogy') STATE.hardware.mineralogy = e.target.checked;
        if (window.hwManager) hwManager.updateDeviceOptions();
      });
    });

    document.getElementById('pair-ble-caliper').addEventListener('click', async () => {
      toast('Use "Connect" in hardware panel', 'info');
    });

    document.getElementById('select-serial-port').addEventListener('click', async () => {
      if (navigator.serial) {
        try {
          await navigator.serial.requestPort();
          toast('Port selected', 'success');
        } catch (e) {
          toast('Canceled or error', 'warning');
        }
      } else {
        toast('Web Serial not supported', 'error');
      }
    });

<<<<<<< HEAD
=======
    // ========== TABLET IMPORT (placeholder) ==========
    document.getElementById('tablet-import')?.addEventListener('click', () => {
      toast('Import not implemented in tablet view', 'info');
    });

>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
    // ========== RESPONSIVE SWITCH ==========
    function handleResize() {
      const isTablet = window.innerWidth >= 768;
      const phoneList = document.querySelector('.phone-samples-list');
      const tabletPanels = document.querySelector('.samples-panels');
      const tabletNav = document.querySelector('.tablet-nav');
      if (phoneList && tabletPanels && tabletNav) {
        if (isTablet) {
          phoneList.classList.add('hidden');
          tabletPanels.classList.remove('hidden');
          tabletNav.classList.remove('hidden');
        } else {
          phoneList.classList.remove('hidden');
          tabletPanels.classList.add('hidden');
          tabletNav.classList.add('hidden');
        }
      }
      if (!document.getElementById('samples-view').classList.contains('hidden')) {
        if (isTablet) loadTabletSamples(STATE.currentPage);
        else loadPhoneSamples(STATE.currentPage);
      }
    }
    window.addEventListener('resize', handleResize);
    handleResize();

    // ========== INIT ==========
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('splash').classList.add('hidden');
        if (localStorage.getItem('ft_url')) {
          const url = localStorage.getItem('ft_url');
          const token = localStorage.getItem('ft_token');
          STATE.baseUrl = url;
          STATE.token = token;
<<<<<<< HEAD
          api.get('/ping').then(async () => {
            // Load schemes before showing app
            await loadSchemes();
=======
          api.get('/ping').then(() => {
>>>>>>> dd06c297f3b845210fa95f3f50c7543fdf101377
            document.getElementById('connect-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            showView('samples');
            toast('Auto-connected', 'success');
          }).catch(() => {
            document.getElementById('connect-screen').classList.remove('hidden');
          });
        } else {
          document.getElementById('connect-screen').classList.remove('hidden');
        }
      }, 1200);

      // Initialize hardware manager
      window.hwManager = new HardwareManager();
    });

    window.closeSheet = closeSheet;
  </script>
</body>
</html>
