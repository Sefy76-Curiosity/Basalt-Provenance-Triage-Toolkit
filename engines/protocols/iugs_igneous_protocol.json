{
  "protocol_name": "IUGS Igneous Rock Protocol",
  "version": "2.0",
  "author": "Sefy Levy",
  "description": "Standards-accurate JSON implementation of the IUGS igneous rock naming procedure using full TAS volcanic fields, QAPF plutonic fields, and foid-bearing rock logic.",
  "icon": "ðŸª¨",

  "requires_fields": [
    "Sample_ID",
    "SiO2",
    "Na2O",
    "K2O",
    "Q",
    "A",
    "P",
    "F",
    "M"
  ],

  "stages": [

    {
      "id": "missing_data",
      "name": "Missing Data Screening",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [
        {
          "label": "MISSING_MAJOR_OXIDES",
          "conditions_logic": "OR",
          "conditions": [
            { "field": "SiO2", "operator": "is_null" },
            { "field": "Na2O", "operator": "is_null" },
            { "field": "K2O", "operator": "is_null" }
          ],
          "outputs": {
            "QC_Class": "INSUFFICIENT_DATA",
            "Flag_For_Review": "YES",
            "Review_Reason": "Missing major oxide data"
          }
        }
      ]
    },

    {
      "id": "tas_field",
      "name": "TAS Volcanic Field Assignment (Full IUGS)",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [

        {
          "label": "BASALT",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "SiO2", "operator": "<", "value": 52 }
          ],
          "outputs": { "TAS_Class": "BASALT" }
        },

        {
          "label": "BASALTIC_ANDESITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "SiO2", "operator": "between", "value": [52, 57] }
          ],
          "outputs": { "TAS_Class": "BASALTIC_ANDESITE" }
        },

        {
          "label": "ANDESITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "SiO2", "operator": "between", "value": [57, 63] }
          ],
          "outputs": { "TAS_Class": "ANDESITE" }
        },

        {
          "label": "DACITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "SiO2", "operator": "between", "value": [63, 69] }
          ],
          "outputs": { "TAS_Class": "DACITE" }
        },

        {
          "label": "RHYOLITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "SiO2", "operator": ">=", "value": 69 }
          ],
          "outputs": { "TAS_Class": "RHYOLITE" }
        }
      ]
    },

    {
      "id": "foid_check",
      "name": "Foid-Bearing Rock Check (F > 10%)",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [
        {
          "label": "FOID_BEARING",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "F", "operator": ">", "value": 10 }
          ],
          "outputs": { "Foid_Flag": "YES" }
        }
      ]
    },

    {
      "id": "qapf_field",
      "name": "QAPF Plutonic Field Assignment (Full IUGS)",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [

        {
          "label": "GRANITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Q", "operator": ">=", "value": 20 },
            { "field": "A", "operator": ">=", "value": 20 }
          ],
          "outputs": { "QAPF_Class": "GRANITE" }
        },

        {
          "label": "GRANODIORITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Q", "operator": "between", "value": [5, 20] },
            { "field": "A", "operator": ">=", "value": 20 }
          ],
          "outputs": { "QAPF_Class": "GRANODIORITE" }
        },

        {
          "label": "TONALITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Q", "operator": "between", "value": [5, 20] },
            { "field": "A", "operator": "<", "value": 20 }
          ],
          "outputs": { "QAPF_Class": "TONALITE" }
        },

        {
          "label": "GABBRO",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Q", "operator": "<", "value": 5 },
            { "field": "M", "operator": ">=", "value": 35 }
          ],
          "outputs": { "QAPF_Class": "GABBRO" }
        }
      ]
    },

    {
      "id": "foid_assignment",
      "name": "Foid Rock Assignment (Overrides QAPF/TAS)",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [

        {
          "label": "FOID_SYENITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Foid_Flag", "operator": "==", "value": "YES" },
            { "field": "A", "operator": ">=", "value": 35 }
          ],
          "outputs": { "Final_Class": "FOID_SYENITE" }
        },

        {
          "label": "FOID_MONZOSYENITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Foid_Flag", "operator": "==", "value": "YES" },
            { "field": "A", "operator": "between", "value": [20, 35] }
          ],
          "outputs": { "Final_Class": "FOID_MONZOSYENITE" }
        },

        {
          "label": "FOIDOLITE",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Foid_Flag", "operator": "==", "value": "YES" },
            { "field": "F", "operator": ">", "value": 60 }
          ],
          "outputs": { "Final_Class": "FOIDOLITE" }
        }
      ]
    },

    {
      "id": "final_assignment",
      "name": "Final Igneous Assignment (Volcanic vs Plutonic)",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [

        {
          "label": "VOLCANIC_FINAL",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Final_Class", "operator": "is_null" },
            { "field": "TAS_Class", "operator": "is_not_null" }
          ],
          "outputs": {
            "Final_Class": { "copy_field": "TAS_Class" }
          }
        },

        {
          "label": "PLUTONIC_FINAL",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Final_Class", "operator": "is_null" },
            { "field": "QAPF_Class", "operator": "is_not_null" }
          ],
          "outputs": {
            "Final_Class": { "copy_field": "QAPF_Class" }
          }
        }
      ]
    },

    {
      "id": "review_stage",
      "name": "Review Flags",
      "type": "rule_stage",
      "rules_logic": "OR",
      "rules": [
        {
          "label": "UNCLASSIFIED",
          "conditions_logic": "AND",
          "conditions": [
            { "field": "Final_Class", "operator": "is_null" }
          ],
          "outputs": {
            "Flag_For_Review": "YES",
            "Review_Reason": "No igneous classification possible"
          }
        }
      ]
    }
  ],

  "final_outputs": {
    "primary_classification_field": "Final_Class",
    "qc_field": "QC_Class",
    "flag_field": "Flag_For_Review"
  }
}
